<!DOCTYPE html><html><head><meta charset="UTF-8"/><title>motion detection - WecRTC Example</title><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no"/><style>body,html{height:100%}canvas,video{vertical-align:bottom;opacity:0}#btn,#center{position:absolute;z-index:9999}*{margin:0;padding:0;-webkit-user-select:none}html{overflow:auto;background-color:#000}body{overflow:hidden;font-family:'Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3',Meiryo,メイリオ,Osaka,'MS PGothic',arial,helvetica,sans-serif;font-size:12px}canvas{position:absolute;left:0;top:0;z-index:0}#btn{font-size:14px;line-height:32px;height:32px;text-align:right;right:0;bottom:0}#btn span{display:inline-block;cursor:pointer;background-color:rgba(128,128,128,.8);-webkit-tap-highlight-color:transparent;padding:0 8px}#center{color:#CCC;top:50%;left:50%;-webkit-transform:translateY(-50%) translateX(-50%);transform:translateY(-50%) translateX(-50%);padding:32px;border:1px solid #ccc;display:none}</style></head><body><script src="three.min.js"></script><script src="opticalflow.js"></script><script>var video;!function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.crel=t()}(this,function(){function e(){var o,v=arguments,f=v[0],u=v[1],p=2,m=v.length,g=e[n];if(f=e[s](f)?f:l.createElement(f),1===m)return f;if((!c(u,i)||e[d](u)||h(u))&&(--p,u=null),m-p===1&&c(v[p],"string")&&void 0!==f[a])f[a]=v[p];else for(;m>p;++p)if(o=v[p],null!=o)if(h(o))for(var w=0;w<o.length;++w)y(f,o[w]);else y(f,o);for(var x in u)if(g[x]){var b=g[x];typeof b===t?b(f,u[x]):f[r](b,u[x])}else f[r](x,u[x]);return f}var t="function",i="object",o="nodeType",a="textContent",r="setAttribute",n="attrMap",d="isNode",s="isElement",l=typeof document===i?document:{},c=function(e,t){return typeof e===t},v=typeof Node===t?function(e){return e instanceof Node}:function(e){return e&&c(e,i)&&o in e&&c(e.ownerDocument,i)},f=function(t){return e[d](t)&&1===t[o]},h=function(e){return e instanceof Array},y=function(t,i){e[d](i)||(i=l.createTextNode(i)),t.appendChild(i)};return e[n]={},e[s]=f,e[d]=v,"undefined"!=typeof Proxy&&(e.proxy=new Proxy(e,{get:function(t,i){return!(i in e)&&(e[i]=e.bind(null,i)),e[i]}})),e}),function(){var e=crel("div");void 0==e.innerText&&Object.defineProperty(HTMLElement.prototype,"innerText",{get:function(){return this.textContent},set:function(e){this.textContent=e}})}();var ua=window.navigator.userAgent.toLowerCase(),ios=ua.indexOf("iphone")>0||ua.indexOf("ipad")>0||ua.indexOf("ipod")>0,sp=!!(ios||ua.indexOf("android")>0),safari=ua.indexOf("safari")!==-1&&ua.indexOf("chrome")===-1,description=crel("p",{id:"center"});crel(document.body,description);var loadedmetadata=!1,defalt={w:0,h:0},current={w:0,h:0},vec={w:0,h:0},src={w:0,h:0},isReload=!1,frontCamera=!1,video,medias={audio:!1,video:{}};sp&&(medias.video.facingMode={exact:"user"});var initialize=function(){frontCamera=!!(!sp||medias.video.facingMode&&medias.video.facingMode.exact&&"user"===medias.video.facingMode.exact),video=crel("video",{autoplay:"",playsinline:""}),crel(document.body,video),video.addEventListener("loadedmetadata",function(e){function t(e,t){var i=new THREE.WebGLRenderer({alpha:!0});return i.setClearColor(0,0),i.setSize(e,t),document.body.appendChild(i.domElement),i}function i(e,t,i){var o=new THREE.BoxGeometry(e,t,i),a=new THREE.MeshLambertMaterial({color:"#FFFFFF"}),r=new THREE.Mesh(o,a),n=new THREE.DirectionalLight(16777215,1);return n.position.set(0,0,100),f.add(n),r}function o(e,t,i){m=new THREE.Matrix4,m.makeRotationAxis(t.normalize(),i),m.multiply(e.matrix),e.matrix=m,e.rotation.setFromRotationMatrix(e.matrix)}if(!loadedmetadata){loadedmetadata=!0,sp?video.videoHeight>video.videoWidth?(defalt.w=video.videoWidth,defalt.h=video.videoHeight):(isReload=!0,defalt.h=video.videoWidth,defalt.w=video.videoHeight):(defalt.w=video.videoWidth,defalt.h=video.videoHeight);var a=crel("canvas");a.width=video.videoWidth,a.height=video.videoHeight;var r=a.getContext("2d");frontCamera&&(r.translate(a.width,0),r.scale(-1,1),video.style.cssText="-moz-transform: scale(-1, 1); -webkit-transform: scale(-1, 1); -o-transform: scale(-1, 1); transform: scale(-1, 1); filter: FlipH;");var n=crel("span","HIDE DETECTION");n.addEventListener("click",function(e){s=!s,n.innerText=s?"HIDE DETECTION":"SHOW DETECTION",n.style.backgroundColor=s?"rgba(128,128,128,0.8)":"rgba(0,197,170,0.8)"});var d=crel("div",{id:"btn"},n);crel(document.body,d);var s=!0,l=a.width,c=a.height,v=Math.min(l,c)/50,f=new THREE.Scene,h=new THREE.PerspectiveCamera(30,l/c,1,1e3),y=t(l,c),u=i(v,v,v);h.position.z=64,f.add(u);var p=y.domElement;p.style.opacity=.85,p.style.background="rgba(0,0,0,0.2)",crel(document.body,a),src.w=video.videoWidth>>1,src.h=video.videoHeight>>1;var m,g=crel("canvas",{width:src.w,height:src.h}),w=g.getContext("2d"),x=new THREE.Vector3(1,0,0),b=new THREE.Vector3(0,1,0),E=Module.cwrap("setup","void",["number","number"]),T=Module.cwrap("calc","void",["number","number"]);E(src.w,src.h);var M=src.w*src.h,H=new Uint8Array(Module.HEAPU8.buffer,Module._malloc(4*M),4*M);vec.w=video.videoWidth/16,vec.h=video.videoHeight/16;var U=vec.w*vec.h,C=new Uint8Array(Module.HEAPU8.buffer,Module._malloc(2*U),2*U),R=(r.getImageData(0,0,video.videoWidth,video.videoHeight),0),L=0,O=setInterval(function(e){if(0!==defalt.w||0!==current.w||0!==defalt.h||0!==current.h)if(sp&&defalt.w!=video.videoWidth&&defalt.h!=video.videoHeight)a.style.opacity=video.style.opacity=0,p.style.display="none",n.style.display="none",description.innerText="縦向きにしてください",description.style.display="block";else{if(sp){if(isReload===!0)return clearInterval(O),void location.reload();description.style.display="none"}p.style.display="block",n.style.display="block",a.style.opacity=video.style.opacity=1;var t={w:document.documentElement.clientWidth,h:document.documentElement.clientHeight};if(t.w!=current.w||t.h!=current.h){current.w=t.w,current.h=t.h;var i=0,l=0;if(t.w-defalt.w>=0&&t.h-defalt.h>=0)p.style.width=a.style.width=video.style.width=defalt.w+"px",p.style.height=a.style.height=video.style.height=defalt.h+"px",i=t.w-defalt.w>>1,l=t.h-defalt.h>>1,p.style.marginLeft=a.style.marginLeft=video.style.marginLeft=i+"px",p.style.marginTop=a.style.marginTop=video.style.marginTop=l+"px";else{var c=t.w/defalt.w,v=t.h/defalt.h;if(c<v){p.style.marginLeft=a.style.marginLeft=video.style.marginLeft="0px";var m=t.h*c*(1/v)>>0;p.style.width=a.style.width=video.style.width=t.w+"px",p.style.height=a.style.height=video.style.height=m+"px",l=t.h-m>>1,p.style.marginTop=a.style.marginTop=video.style.marginTop=l+"px",d.style.bottom=l+"px"}else{p.style.marginTop=a.style.marginTop=video.style.marginTop="0px";var g=t.w*v*(1/c)>>0;p.style.width=a.style.width=video.style.width=g+"px",p.style.height=a.style.height=video.style.height=t.h+"px",i=t.w-g>>1,p.style.marginLeft=a.style.marginLeft=video.style.marginLeft=i+"px"}}d.style.bottom=l+6+"px",d.style.right=i+6+"px"}w.drawImage(video,0,0,src.w,src.h),H.set(new Uint8Array(w.getImageData(0,0,src.w,src.h).data.buffer)),T(H.byteOffset,C.byteOffset),r.clearRect(0,0,video.videoWidth,video.videoHeight);var E=4,M=4,U=0,k=0;if(s){r.lineCap="round",r.lineWidth=2,r.strokeStyle="rgba(0,197,170,0.6)",r.beginPath();for(var W=0;W<vec.h;W++)for(var D=0;D<vec.w;D++){var I=C[2*(W*vec.w+D)+0]-128,A=C[2*(W*vec.w+D)+1]-128,P=I*I+A*A;if(P>49&&P<256){U+=I,k+=A;var z=E+8*D*2,F=M+8*W*2;r.moveTo(z,F),r.lineTo(z+1.5*I,F+1.5*A)}}r.closePath(),r.stroke()}else for(var W=0;W<vec.h;W++)for(var D=0;D<vec.w;D++){var I=C[2*(W*vec.w+D)+0]-128,A=C[2*(W*vec.w+D)+1]-128,P=I*I+A*A;if(P>49&&P<256){U+=I,k+=A;var z=E+8*D*2,F=M+8*W*2}}U/=vec.w*vec.h*.01,k/=vec.w*vec.h*.01,k*=.8,R=.7*R+.3*U,L=.7*L+.3*k,R>100&&(R=100),L>100&&(L=100),R<-100&&(R=-100),L<-100&&(L=-100);var N=Math.sqrt(R*R+L*L)*(R<0?-1:1)*2;N>100&&(N=100),N<-100&&(N=-100),h.updateProjectionMatrix(),o(u,x,.002*L),o(u,b,-N/1e3),y.render(f,h)}},33)}})},noUserMedia=function(){ios?(description.innerText="iOS11 Safariで開いてください",description.style.display="block"):(description.innerText="カメラが必要です",description.style.display="block")},allowUserMedia=function(){description.innerText="カメラを許可してください",description.style.display="block"};safari&&!ios?(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?(initialize(),navigator.getUserMedia(medias,function(e){video.srcObject=e},function(e){allowUserMedia()})):noUserMedia()):navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(initialize(),navigator.mediaDevices.getUserMedia(medias).then(function(e){video.srcObject=e})["catch"](function(e){allowUserMedia()})):noUserMedia();</script><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-55075754-4","auto"),ga("send","pageview");</script></body></html>