<!DOCTYPE html><html><head><meta charset="UTF-8"/><title>opticalflow</title><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no"/><style>body,html{height:100%}canvas,video{vertical-align:bottom;opacity:0}#btn,#center{position:absolute;z-index:9999}*{margin:0;padding:0;-webkit-user-select:none}html{overflow:auto;background-color:#000}body{overflow:hidden;font-family:'Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3',Meiryo,メイリオ,Osaka,'MS PGothic',arial,helvetica,sans-serif;font-size:12px}canvas{position:absolute;left:0;top:0;z-index:0}#btn{font-size:14px;line-height:32px;height:32px;text-align:right;right:0;bottom:0}#btn span{display:inline-block;cursor:pointer;background-color:rgba(128,128,128,.8);-webkit-tap-highlight-color:transparent;padding:0 8px}#center{color:#CCC;top:50%;left:50%;-webkit-transform:translateY(-50%) translateX(-50%);transform:translateY(-50%) translateX(-50%);padding:32px;border:1px solid #ccc;display:none}</style></head><body><script src="three.min.js"></script><script src="opticalflow.js"></script><script>!function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.crel=t()}(this,function(){function e(){var o,v=arguments,f=v[0],p=v[1],u=2,m=v.length,g=e[d];if(f=e[l](f)?f:s.createElement(f),1===m)return f;if((!c(p,i)||e[a](p)||h(p))&&(--u,p=null),m-u===1&&c(v[u],"string")&&void 0!==f[r])f[r]=v[u];else for(;m>u;++u)if(o=v[u],null!=o)if(h(o))for(var w=0;w<o.length;++w)y(f,o[w]);else y(f,o);for(var x in p)if(g[x]){var b=g[x];typeof b===t?b(f,p[x]):f[n](b,p[x])}else f[n](x,p[x]);return f}var t="function",i="object",o="nodeType",r="textContent",n="setAttribute",d="attrMap",a="isNode",l="isElement",s=typeof document===i?document:{},c=function(e,t){return typeof e===t},v=typeof Node===t?function(e){return e instanceof Node}:function(e){return e&&c(e,i)&&o in e&&c(e.ownerDocument,i)},f=function(t){return e[a](t)&&1===t[o]},h=function(e){return e instanceof Array},y=function(t,i){e[a](i)||(i=s.createTextNode(i)),t.appendChild(i)};return e[d]={},e[l]=f,e[a]=v,"undefined"!=typeof Proxy&&(e.proxy=new Proxy(e,{get:function(t,i){return!(i in e)&&(e[i]=e.bind(null,i)),e[i]}})),e}),function(){var e=crel("div");void 0==e.innerText&&Object.defineProperty(HTMLElement.prototype,"innerText",{get:function(){return this.textContent},set:function(e){this.textContent=e}})}();var ua=window.navigator.userAgent.toLowerCase(),ios=ua.indexOf("iphone")>0||ua.indexOf("ipad")>0||ua.indexOf("ipod")>0,sp=!!(ios||ua.indexOf("android")>0),description=crel("p",{id:"center"});crel(document.body,description);var loadedmetadata=!1,defalt={w:0,h:0},current={w:0,h:0},vec={w:0,h:0},src={w:0,h:0},isReload=!1,frontCamera=!1;if(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia,navigator.getUserMedia){var medias={audio:!1,video:{}};sp&&(medias.video.facingMode={exact:"user"}),frontCamera=!!(!sp||medias.video.facingMode&&medias.video.facingMode.exact&&"user"===medias.video.facingMode.exact),video=crel("video",{autoplay:"",playsinline:""}),crel(document.body,video),video.addEventListener("loadedmetadata",function(e){function t(e,t){var i=new THREE.WebGLRenderer({alpha:!0});return i.setClearColor(0,0),i.setSize(e,t),document.body.appendChild(i.domElement),i}function i(e,t,i){var o=new THREE.BoxGeometry(e,t,i),r=new THREE.MeshLambertMaterial({color:"#FFFFFF"}),n=new THREE.Mesh(o,r),d=new THREE.DirectionalLight(16777215,1);return d.position.set(0,0,100),f.add(d),n}function o(e,t,i){m=new THREE.Matrix4,m.makeRotationAxis(t.normalize(),i),m.multiply(e.matrix),e.matrix=m,e.rotation.setFromRotationMatrix(e.matrix)}if(!loadedmetadata){loadedmetadata=!0,sp?video.videoHeight>video.videoWidth?(defalt.w=video.videoWidth,defalt.h=video.videoHeight):(isReload=!0,defalt.h=video.videoWidth,defalt.w=video.videoHeight):(defalt.w=video.videoWidth,defalt.h=video.videoHeight);var r=crel("canvas");r.width=video.videoWidth,r.height=video.videoHeight;var n=r.getContext("2d");frontCamera&&(n.translate(r.width,0),n.scale(-1,1),video.style.cssText="-moz-transform: scale(-1, 1); -webkit-transform: scale(-1, 1); -o-transform: scale(-1, 1); transform: scale(-1, 1); filter: FlipH;");var d=crel("span","HIDE DETECTION");d.addEventListener("click",function(e){l=!l,d.innerText=l?"HIDE DETECTION":"SHOW DETECTION",d.style.backgroundColor=l?"rgba(128,128,128,0.8)":"rgba(0,197,170,0.8)"});var a=crel("div",{id:"btn"},d);crel(document.body,a);var l=!0,s=r.width,c=r.height,v=Math.min(s,c)/50,f=new THREE.Scene,h=new THREE.PerspectiveCamera(30,s/c,1,1e3),y=t(s,c),p=i(v,v,v);h.position.z=64,f.add(p);var u=y.domElement;u.style.opacity=.85,u.style.background="rgba(0,0,0,0.2)",crel(document.body,r),src.w=video.videoWidth>>1,src.h=video.videoHeight>>1;var m,g=crel("canvas",{width:src.w,height:src.h}),w=g.getContext("2d"),x=new THREE.Vector3(1,0,0),b=new THREE.Vector3(0,1,0),E=Module.cwrap("setup","void",["number","number"]),T=Module.cwrap("calc","void",["number","number"]);E(src.w,src.h);var H=src.w*src.h,M=new Uint8Array(Module.HEAPU8.buffer,Module._malloc(4*H),4*H);vec.w=video.videoWidth/16,vec.h=video.videoHeight/16;var C=vec.w*vec.h,R=new Uint8Array(Module.HEAPU8.buffer,Module._malloc(2*C),2*C),L=(n.getImageData(0,0,video.videoWidth,video.videoHeight),0),k=0,W=setInterval(function(e){if(0!==defalt.w||0!==current.w||0!==defalt.h||0!==current.h)if(sp&&defalt.w!=video.videoWidth&&defalt.h!=video.videoHeight)r.style.opacity=video.style.opacity=0,u.style.display="none",d.style.display="none",description.innerText="縦向きにしてください",description.style.display="block";else{if(sp){if(isReload===!0)return clearInterval(W),void location.reload();description.style.display="none"}u.style.display="block",d.style.display="block",r.style.opacity=video.style.opacity=1;var t={w:document.documentElement.clientWidth,h:document.documentElement.clientHeight};if(t.w!=current.w||t.h!=current.h){current.w=t.w,current.h=t.h;var i=0,s=0;if(t.w-defalt.w>=0&&t.h-defalt.h>=0)u.style.width=r.style.width=video.style.width=defalt.w+"px",u.style.height=r.style.height=video.style.height=defalt.h+"px",i=t.w-defalt.w>>1,s=t.h-defalt.h>>1,u.style.marginLeft=r.style.marginLeft=video.style.marginLeft=i+"px",u.style.marginTop=r.style.marginTop=video.style.marginTop=s+"px";else{var c=t.w/defalt.w,v=t.h/defalt.h;if(c<v){u.style.marginLeft=r.style.marginLeft=video.style.marginLeft="0px";var m=t.h*c*(1/v)>>0;u.style.width=r.style.width=video.style.width=t.w+"px",u.style.height=r.style.height=video.style.height=m+"px",s=t.h-m>>1,u.style.marginTop=r.style.marginTop=video.style.marginTop=s+"px",a.style.bottom=s+"px"}else{u.style.marginTop=r.style.marginTop=video.style.marginTop="0px";var g=t.w*v*(1/c)>>0;u.style.width=r.style.width=video.style.width=g+"px",u.style.height=r.style.height=video.style.height=t.h+"px",i=t.w-g>>1,u.style.marginLeft=r.style.marginLeft=video.style.marginLeft=i+"px"}}a.style.bottom=s+6+"px",a.style.right=i+6+"px"}w.drawImage(video,0,0,src.w,src.h),M.set(new Uint8Array(w.getImageData(0,0,src.w,src.h).data.buffer)),T(M.byteOffset,R.byteOffset),n.clearRect(0,0,video.videoWidth,video.videoHeight);var E=4,H=4,C=0,O=0;if(l){n.lineCap="round",n.lineWidth=2,n.strokeStyle="rgba(0,197,170,0.6)",n.beginPath();for(var I=0;I<vec.h;I++)for(var U=0;U<vec.w;U++){var A=R[2*(I*vec.w+U)+0]-128,D=R[2*(I*vec.w+U)+1]-128,P=A*A+D*D;if(P>49&&P<256){C+=A,O+=D;var F=E+8*U*2,N=H+8*I*2;n.moveTo(F,N),n.lineTo(F+1.5*A,N+1.5*D)}}n.closePath(),n.stroke()}else for(var I=0;I<vec.h;I++)for(var U=0;U<vec.w;U++){var A=R[2*(I*vec.w+U)+0]-128,D=R[2*(I*vec.w+U)+1]-128,P=A*A+D*D;if(P>49&&P<256){C+=A,O+=D;var F=E+8*U*2,N=H+8*I*2}}C/=vec.w*vec.h*.01,O/=vec.w*vec.h*.01,O*=.8,L=.7*L+.3*C,k=.7*k+.3*O,L>100&&(L=100),k>100&&(k=100),L<-100&&(L=-100),k<-100&&(k=-100);var j=Math.sqrt(L*L+k*k)*(L<0?-1:1)*2;j>100&&(j=100),j<-100&&(j=-100),h.updateProjectionMatrix(),o(p,x,.002*k),o(p,b,-j/1e3),y.render(f,h)}},33)}}),navigator.getUserMedia(medias,function(e){video.srcObject=e},function(e){description.innerText="カメラを許可してください",description.style.display="block"})}else ios?(description.innerText="iOS11以降が必要です",description.style.display="block"):(description.innerText="カメラが必要です",description.style.display="block");</script></body></html>